<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý quỹ cơm</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Hàm định dạng tiền tệ VND
    const formatVND = (number) => {
      return Math.floor(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };

    // Hàm định dạng input VND
    const formatInputVND = (value) => {
      const digits = value.replace(/[^0-9]/g, "");
      return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };

    // Khởi tạo Supabase client
    let supabase;
    if (typeof window.supabase !== "undefined") {
      supabase = window.supabase.createClient(
        "YOUR_SUPABASE_URL", // Thay bằng SUPABASE_URL
        "YOUR_SUPABASE_ANON_KEY" // Thay bằng SUPABASE_ANON_KEY
      );
    } else {
      console.error("Supabase library not loaded. Please check the CDN.");
    }

    const App = () => {
      const [user, setUser] = useState(null);
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [members, setMembers] = useState([]);
      const [inactiveMembers, setInactiveMembers] = useState([]);
      const [newMemberName, setNewMemberName] = useState("");
      const [events, setEvents] = useState([]);
      const [newEvent, setNewEvent] = useState({ totalCost: "", participants: [], date: "" });
      const [contributions, setContributions] = useState([]);
      const [contributionInputs, setContributionInputs] = useState({});
      const [activeTab, setActiveTab] = useState("addMember");
      const [totalBalance, setTotalBalance] = useState(0);

      // Kiểm tra trạng thái đăng nhập
      useEffect(() => {
        if (!supabase) return;
        const checkSession = async () => {
          const { data: { session } } = await supabase.auth.getSession();
          if (session) {
            const { data: memberData } = await supabase
              .from("members")
              .select("id, name, role")
              .eq("email", session.user.email)
              .single();
            if (memberData) {
              setUser({ ...memberData, email: session.user.email, isAdminUser: false });
            } else if (session.user.email === "admin@luchenfund.com") {
              setUser({ email: session.user.email, role: "admin", isAdminUser: true });
            }
          }
        };
        checkSession();
      }, []);

      // Load dữ liệu từ Supabase
      useEffect(() => {
        if (!supabase || !user) return;
        const fetchData = async () => {
          try {
            const { data: membersData } = await supabase.from("members").select("*");
            const { data: inactiveMembersData } = await supabase.from("inactive_members").select("*");
            const { data: eventsData } = await supabase.from("events").select("*");
            const { data: contributionsData } = await supabase.from("contributions").select("*");
            setMembers(membersData || []);
            setInactiveMembers(inactiveMembersData || []);
            setEvents(eventsData || []);
            setContributions(contributionsData || []);
            const total = (membersData || []).reduce((sum, m) => sum + m.balance, 0);
            setTotalBalance(total);
            console.log("Data loaded from Supabase:", { membersData, inactiveMembersData, eventsData, contributionsData });
          } catch (e) {
            console.error("Error loading data from Supabase:", e);
          }
        };
        fetchData();
      }, [user]);

      const handleLogin = async () => {
        if (!supabase) return;
        try {
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          const { data: { session } } = await supabase.auth.getSession();
          const { data: memberData } = await supabase
            .from("members")
            .select("id, name, role")
            .eq("email", session.user.email)
            .single();
          if (memberData) {
            setUser({ ...memberData, email: session.user.email, isAdminUser: false });
          } else if (session.user.email === "admin@luchenfund.com") {
            setUser({ email: session.user.email, role: "admin", isAdminUser: true });
          } else {
            throw new Error("Tài khoản không hợp lệ");
          }
          setEmail("");
          setPassword("");
          console.log("Logged in:", session.user.email);
        } catch (e) {
          console.error("Login error:", e.message);
          alert("Đăng nhập thất bại: " + e.message);
        }
      };

      const handleLogout = async () => {
        if (!supabase) return;
        try {
          await supabase.auth.signOut();
          setUser(null);
          setMembers([]);
          setInactiveMembers([]);
          setEvents([]);
          setContributions([]);
          setTotalBalance(0);
          console.log("Logged out");
        } catch (e) {
          console.error("Logout error:", e);
        }
      };

      const addMember = async () => {
        if (!supabase || !newMemberName.trim() || (user?.role !== "admin" && !user?.isAdminUser)) return;
        try {
          const { data } = await supabase
            .from("members")
            .insert([{ name: newMemberName, balance: 0, transactions: [], role: "member", email: "" }])
            .select();
          setMembers([...members, data[0]]);
          setNewMemberName("");
          console.log("Added member:", newMemberName);
        } catch (e) {
          console.error("Error adding member:", e);
        }
      };

      const removeMember = async (index) => {
        if (!supabase || (user?.role !== "admin" && !user?.isAdminUser)) return;
        const member = members[index];
        try {
          await supabase.from("inactive_members").insert([member]);
          await supabase.from("members").delete().eq("id", member.id);
          setInactiveMembers([...inactiveMembers, member]);
          setMembers(members.filter((_, i) => i !== index));
          const total = members.filter((_, i) => i !== index).reduce((sum, m) => sum + m.balance, 0);
          setTotalBalance(total);
          console.log("Removed member:", member.name);
        } catch (e) {
          console.error("Error removing member:", e);
        }
      };

      const deleteMember = async (memberId, memberRole) => {
        if (!supabase || (user?.role !== "admin" && !user?.isAdminUser)) return;
        if (!user.isAdminUser && memberRole === "admin") {
          alert("Bạn không có quyền xóa thành viên admin!");
          return;
        }
        if (!window.confirm("Bạn có chắc muốn xóa thành viên này?")) return;
        try {
          const member = members.find((m) => m.id === memberId);
          if (member.email) {
            await supabase.auth.admin.deleteUser(member.auth_user_id);
          }
          await supabase.from("members").delete().eq("id", memberId);
          setMembers(members.filter((m) => m.id !== memberId));
          setTotalBalance(members.filter((m) => m.id !== memberId).reduce((sum, m) => sum + m.balance, 0));
          console.log("Deleted member:", memberId);
        } catch (e) {
          console.error("Error deleting member:", e);
          alert("Xóa thành viên thất bại: " + e.message);
        }
      };

      const reactivateMember = async (index) => {
        if (!supabase || (user?.role !== "admin" && !user?.isAdminUser)) return;
        const member = inactiveMembers[index];
        try {
          await supabase.from("members").insert([member]);
          await supabase.from("inactive_members").delete().eq("id", member.id);
          setMembers([...members, member]);
          setInactiveMembers(inactiveMembers.filter((_, i) => i !== index));
          const total = [...members, member].reduce((sum, m) => sum + m.balance, 0);
          setTotalBalance(total);
          console.log("Reactivated member:", member.name);
        } catch (e) {
          console.error("Error reactivating member:", e);
        }
      };

      const addContribution = async (memberIndex) => {
        if (!supabase || (user?.role !== "admin" && !user?.isAdminUser)) return;
        const rawAmount = contributionInputs[memberIndex] || "";
        const amount = Math.floor(parseInt(rawAmount.replace(/[^0-9]/g, ""), 10) || 0);
        if (amount <= 0 || isNaN(amount)) return;
        const member = members[memberIndex];
        try {
          const updatedTransactions = [
            ...(member.transactions || []),
            { type: "contribution", amount, date: new Date().toLocaleDateString() },
          ];
          const { data } = await supabase
            .from("members")
            .update({ balance: member.balance + amount, transactions: updatedTransactions })
            .eq("id", member.id)
            .select();
          await supabase
            .from("contributions")
            .insert([{ member_name: member.name, amount, date: new Date().toLocaleDateString() }]);
          setMembers(members.map((m, i) => (i === memberIndex ? data[0] : m)));
          setContributions([...contributions, { member_name: member.name, amount, date: new Date().toLocaleDateString() }]);
          setContributionInputs({ ...contributionInputs, [memberIndex]: "" });
          setTotalBalance(totalBalance + amount);
          console.log("Added contribution for", member.name, ":", amount);
        } catch (e) {
          console.error("Error adding contribution:", e);
        }
      };

      const addEvent = async () => {
        if (!supabase || (user?.role !== "admin" && !user?.isAdminUser) || !newEvent.totalCost || newEvent.participants.length === 0) return;
        const rawCost = newEvent.totalCost.replace(/[^0-9]/g, "");
        const totalCost = Math.floor(parseInt(rawCost, 10) || 0);
        if (totalCost <= 0) return;
        const costPerPerson = Math.floor(totalCost / newEvent.participants.length);
        const eventDate = newEvent.date || new Date().toLocaleDateString();
        try {
          const updatedMembers = [...members];
          for (const memberIndex of newEvent.participants) {
            const member = updatedMembers[memberIndex];
            const updatedTransactions = [
              ...(member.transactions || []),
              { type: "meal", amount: costPerPerson, date: eventDate },
            ];
            const { data } = await supabase
              .from("members")
              .update({ balance: member.balance - costPerPerson, transactions: updatedTransactions })
              .eq("id", member.id)
              .select();
            updatedMembers[memberIndex] = data[0];
          }
          const { data: eventData } = await supabase
            .from("events")
            .insert([
              {
                total_cost: totalCost,
                participants: newEvent.participants.map((i) => members[i].name),
                date: eventDate,
              },
            ])
            .select();
          setMembers(updatedMembers);
          setEvents([...events, eventData[0]]);
          setNewEvent({ totalCost: "", participants: [], date: "" });
          setTotalBalance(totalBalance - totalCost);
          console.log("Added event with total cost:", totalCost);
        } catch (e) {
          console.error("Error adding event:", e);
        }
      };

      const toggleParticipant = (index) => {
        if (user?.role !== "admin" && !user?.isAdminUser) return;
        const participants = newEvent.participants.includes(index)
          ? newEvent.participants.filter((i) => i !== index)
          : [...newEvent.participants, index];
        setNewEvent({ ...newEvent, participants });
        console.log("Toggled participant:", members[index]?.name || "Unknown");
      };

      const handleContributionInput = (index, value) => {
        setContributionInputs({ ...contributionInputs, [index]: formatInputVND(value) });
      };

      const clearData = async () => {
        if (!supabase || (user?.role !== "admin" && !user?.isAdminUser)) return;
        if (window.confirm("Bạn có chắc muốn xóa toàn bộ dữ liệu? Hành động này không thể hoàn tác.")) {
          try {
            await supabase.from("members").delete().gte("id", 0);
            await supabase.from("inactive_members").delete().gte("id", 0);
            await supabase.from("events").delete().gte("id", 0);
            await supabase.from("contributions").delete().gte("id", 0);
            setMembers([]);
            setInactiveMembers([]);
            setEvents([]);
            setContributions([]);
            setTotalBalance(0);
            console.log("All data cleared from Supabase");
            window.location.reload();
          } catch (e) {
            console.error("Error clearing data:", e);
          }
        }
      };

      const handleKeyDown = (e, action, index = null) => {
        if (e.key === "Enter") {
          if (action === "login") handleLogin();
          else if (action === "addMember") addMember();
          else if (action === "addContribution" && index !== null) addContribution(index);
          else if (action === "addEvent") addEvent();
        }
      };

      if (!user) {
        return (
          <div className="p-6 max-w-md mx-auto bg-gray-100 min-h-screen flex items-center justify-center">
            <div className="bg-white p-6 rounded-lg shadow">
              <h1 className="text-2xl font-bold mb-4 text-center">Đăng nhập</h1>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                onKeyDown={(e) => handleKeyDown(e, "login")}
                placeholder="Email"
                className="border border-gray-300 p-2 mb-2 w-full rounded-lg"
              />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyDown={(e) => handleKeyDown(e, "login")}
                placeholder="Mật khẩu"
                className="border border-gray-300 p-2 mb-2 w-full rounded-lg"
              />
              <button
                onClick={handleLogin}
                className="bg-blue-500 text-white px-3 py-2 rounded-lg w-full hover:bg-blue-600"
              >
                Đăng nhập
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="p-6 max-w-4xl mx-auto bg-gray-100 min-h-screen relative">
          {/* Total Balance */}
          <div className={`fixed top-4 right-4 text-lg font-bold ${totalBalance >= 0 ? "text-green-600" : "text-red-600"}`}>
            Quỹ: {formatVND(totalBalance)} VND
          </div>

          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-center">Quản lý quỹ cơm</h1>
            <div className="flex items-center space-x-2">
              <span className="text-gray-600">{user.email} ({user.isAdminUser ? "Admin (Khởi tạo)" : user.role})</span>
              <button
                onClick={handleLogout}
                className="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600"
              >
                Đăng xuất
              </button>
              {(user.role === "admin" || user.isAdminUser) && (
                <button
                  onClick={clearData}
                  className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600"
                >
                  Xóa dữ liệu
                </button>
              )}
            </div>
          </div>

          {/* Tabs */}
          <div className="flex mb-6 border-b border-gray-200">
            <button
              className={`px-4 py-2 font-semibold ${activeTab === "addMember" ? "border-b-2 border-blue-500 text-blue-500" : "text-gray-600"}`}
              onClick={() => setActiveTab("addMember")}
            >
              Thêm thành viên
            </button>
            <button
              className={`px-4 py-2 font-semibold ${activeTab === "contribute" ? "border-b-2 border-blue-500 text-blue-500" : "text-gray-600"}`}
              onClick={() => setActiveTab("contribute")}
            >
              Nộp quỹ
            </button>
            <button
              className={`px-4 py-2 font-semibold ${activeTab === "addEvent" ? "border-b-2 border-blue-500 text-blue-500" : "text-gray-600"}`}
              onClick={() => setActiveTab("addEvent")}
            >
              Thêm sự kiện
            </button>
            {(user.role === "admin" || user.isAdminUser) && (
              <button
                className={`px-4 py-2 font-semibold ${activeTab === "manageMembers" ? "border-b-2 border-blue-500 text-blue-500" : "text-gray-600"}`}
                onClick={() => setActiveTab("manageMembers")}
              >
                Quản lý thành viên
              </button>
            )}
          </div>

          {/* Tab Content */}
          {activeTab === "addMember" && (
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-semibold mb-2">Thêm thành viên</h2>
              <div className="flex items-center">
                <input
                  type="text"
                  value={newMemberName}
                  onChange={(e) => setNewMemberName(e.target.value)}
                  onKeyDown={(e) => handleKeyDown(e, "addMember")}
                  placeholder="Tên thành viên"
                  className="border border-gray-300 p-2 mr-2 rounded-lg flex-grow"
                  disabled={user.role !== "admin" && !user.isAdminUser}
                />
                <button
                  onClick={addMember}
                  className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600"
                  disabled={user.role !== "admin" && !user.isAdminUser}
                >
                  Thêm
                </button>
              </div>
            </div>
          )}

          {activeTab === "contribute" && (
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-semibold mb-2">Nộp quỹ</h2>
              <div className="space-y-2">
                {members.map((member, index) => (
                  <div key={member.id} className="flex items-center">
                    <span className="w-32 text-right mr-2">{member.name}:</span>
                    <input
                      type="text"
                      value={contributionInputs[index] || ""}
                      onChange={(e) => handleContributionInput(index, e.target.value)}
                      onKeyDown={(e) => handleKeyDown(e, "addContribution", index)}
                      placeholder="Số tiền (VND)"
                      className="border border-gray-300 p-2 mr-2 rounded-lg w-40"
                      disabled={user.role !== "admin" && !user.isAdminUser}
                    />
                    <button
                      onClick={() => addContribution(index)}
                      className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600"
                      disabled={user.role !== "admin" && !user.isAdminUser}
                    >
                      Nộp
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {activeTab === "addEvent" && (
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-semibold mb-2">Thêm sự kiện (bữa ăn)</h2>
              <input
                type="text"
                value={newEvent.totalCost}
                onChange={(e) => setNewEvent({ ...newEvent, totalCost: formatInputVND(e.target.value) })}
                onKeyDown={(e) => handleKeyDown(e, "addEvent")}
                placeholder="Tổng chi phí (VND)"
                className="border border-gray-300 p-2 mb-2 w-full rounded-lg"
                disabled={user.role !== "admin" && !user.isAdminUser}
              />
              <input
                type="date"
                value={newEvent.date}
                onChange={(e) => setNewEvent({ ...newEvent, date: e.target.value })}
                className="border border-gray-300 p-2 mb-2 w-full rounded-lg"
                disabled={user.role !== "admin" && !user.isAdminUser}
              />
              <h3 className="font-semibold mb-2">Chọn thành viên tham gia:</h3>
              {members.map((member, index) => (
                <div key={member.id} className="flex items-center mb-2">
                  <input
                    type="checkbox"
                    checked={newEvent.participants.includes(index)}
                    onChange={() => toggleParticipant(index)}
                    className="mr-2"
                    disabled={user.role !== "admin" && !user.isAdminUser}
                  />
                  <span>{member.name}</span>
                </div>
              ))}
              <button
                onClick={addEvent}
                className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 mt-2"
                disabled={user.role !== "admin" && !user.isAdminUser}
              >
                Thêm sự kiện
              </button>
            </div>
          )}

          {activeTab === "manageMembers" && (user.role === "admin" || user.isAdminUser) && (
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-semibold mb-2">Quản lý thành viên</h2>
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-gray-200">
                    <th className="border p-2">Tên</th>
                    <th className="border p-2">Vai trò</th>
                    <th className="border p-2">Số dư (VND)</th>
                    <th className="border p-2">Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  {members.map((m) => (
                    <tr key={m.id}>
                      <td className="border p-2">{m.name}</td>
                      <td className="border p-2">{m.role}</td>
                      <td className="border p-2">{formatVND(m.balance)}</td>
                      <td className="border p-2">
                        <button
                          onClick={() => deleteMember(m.id, m.role)}
                          className="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600"
                          disabled={m.email === user.email || (!user.isAdminUser && m.role === "admin")}
                        >
                          Xóa
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* Danh sách thành viên */}
          <div className="mb-6 bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Danh sách thành viên</h2>
            <table className="w-full border-collapse">
              <thead>
                <tr className="bg-gray-200">
                  <th className="border p-2">Tên</th>
                  <th className="border p-2">Số dư (VND)</th>
                  <th className="border p-2">Hành động</th>
                </tr>
              </thead>
              <tbody>
                {members.map((member, index) => (
                  <tr key={member.id}>
                    <td className="border p-2">{member.name}</td>
                    <td className="border p-2">{formatVND(member.balance)}</td>
                    <td className="border p-2">
                      <button
                        onClick={() => removeMember(index)}
                        className="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600"
                        disabled={user.role !== "admin" && !user.isAdminUser}
                      >
                        Loại bỏ
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Thành viên cũ */}
          <div className="mb-6 bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Thành viên cũ</h2>
            <table className="w-full border-collapse">
              <thead>
                <tr className="bg-gray-200">
                  <th className="border p-2">Tên</th>
                  <th className="border p-2">Số dư (VND)</th>
                  <th className="border p-2">Hành động</th>
                </tr>
              </thead>
              <tbody>
                {inactiveMembers.map((member, index) => (
                  <tr key={member.id}>
                    <td className="border p-2">{member.name}</td>
                    <td className="border p-2">{formatVND(member.balance)}</td>
                    <td className="border p-2">
                      <button
                        onClick={() => reactivateMember(index)}
                        className="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600"
                        disabled={user.role !== "admin" && !user.isAdminUser}
                      >
                        Kích hoạt lại
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Lịch sử giao dịch */}
          <div className="mb-6 bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Lịch sử giao dịch</h2>
            {members.map((member, index) => (
              <div key={member.id} className="mb-4">
                <h3 className="font-semibold">{member.name}</h3>
                <ul>
                  {(member.transactions || []).map((txn, i) => (
                    <li key={i} className={txn.type === "contribution" ? "text-green-600" : "text-red-600"}>
                      {txn.date}: {txn.type === "contribution" ? "+" : "-"} {formatVND(txn.amount)} VND
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>

          {/* Lịch sử sự kiện nhóm */}
          <div className="bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Lịch sử sự kiện nhóm</h2>
            <ul>
              {events.map((event, index) => (
                <li key={event.id}>
                  {event.date}: Tổng chi phí {formatVND(event.total_cost)} VND, Thành viên: {event.participants.join(", ")}
                </li>
              ))}
            </ul>
          </div>
        </div>
      );
    };

    try {
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
      console.log("ReactDOM.createRoot called successfully");
    } catch (e) {
      console.error("Error rendering React app:", e);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý quỹ cơm</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Hàm định dạng tiền tệ VND
    const formatVND = (number) => {
      return Math.floor(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };

    // Khởi tạo Supabase client
    let supabase;
    if (typeof window.supabase !== "undefined") {
      supabase = window.supabase.createClient(
        "https://xlshingqqouzqbljysmi.supabase.co", // Thay bằng SUPABASE_URL từ Dashboard
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhsc2hpbmdxcW91enFibGp5c21pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMzQxODYsImV4cCI6MjA2NDYxMDE4Nn0.v9YlKzHEA4a5Ib1LP7Bd_1m1zHFBw_2CjgCBDXmwixQ" // Thay bằng SUPABASE_ANON_KEY từ Dashboard
      );
    } else {
      console.error("Supabase library not loaded. Please check the CDN.");
    }

    const App = () => {
      const [members, setMembers] = useState([]);
      const [inactiveMembers, setInactiveMembers] = useState([]);
      const [newMemberName, setNewMemberName] = useState("");
      const [events, setEvents] = useState([]);
      const [newEvent, setNewEvent] = useState({ totalCost: 0, participants: [], date: "" });
      const [contributions, setContributions] = useState([]);
      const [contributionInputs, setContributionInputs] = useState({});
      const [activeTab, setActiveTab] = useState("addMember");

      console.log("App component initialized");

      // Load data from Supabase
      useEffect(() => {
        if (!supabase) return;
        const fetchData = async () => {
          try {
            const { data: membersData } = await supabase.from("members").select("*");
            const { data: inactiveMembersData } = await supabase.from("inactive_members").select("*");
            const { data: eventsData } = await supabase.from("events").select("*");
            const { data: contributionsData } = await supabase.from("contributions").select("*");
            setMembers(membersData || []);
            setInactiveMembers(inactiveMembersData || []);
            setEvents(eventsData || []);
            setContributions(contributionsData || []);
            console.log("Data loaded from Supabase:", { membersData, inactiveMembersData, eventsData, contributionsData });
          } catch (e) {
            console.error("Error loading data from Supabase:", e);
          }
        };
        fetchData();
      }, []);

      const addMember = async () => {
        if (!supabase || !newMemberName.trim()) return;
        try {
          const { data } = await supabase
            .from("members")
            .insert([{ name: newMemberName, balance: 0, transactions: [] }])
            .select();
          setMembers([...members, data[0]]);
          setNewMemberName("");
          console.log("Added member:", newMemberName);
        } catch (e) {
          console.error("Error adding member:", e);
        }
      };

      const removeMember = async (index) => {
        if (!supabase) return;
        const member = members[index];
        try {
          await supabase.from("inactive_members").insert([member]);
          await supabase.from("members").delete().eq("id", member.id);
          setInactiveMembers([...inactiveMembers, member]);
          setMembers(members.filter((_, i) => i !== index));
          console.log("Removed member:", member.name);
        } catch (e) {
          console.error("Error removing member:", e);
        }
      };

      const reactivateMember = async (index) => {
        if (!supabase) return;
        const member = inactiveMembers[index];
        try {
          await supabase.from("members").insert([member]);
          await supabase.from("inactive_members").delete().eq("id", member.id);
          setMembers([...members, member]);
          setInactiveMembers(inactiveMembers.filter((_, i) => i !== index));
          console.log("Reactivated member:", member.name);
        } catch (e) {
          console.error("Error reactivating member:", e);
        }
      };

      const addContribution = async (memberIndex) => {
        if (!supabase) return;
        const amount = Math.floor(parseFloat(contributionInputs[memberIndex] || 0));
        if (amount <= 0 || isNaN(amount)) return;
        const member = members[memberIndex];
        try {
          const updatedTransactions = [
            ...(member.transactions || []),
            { type: "contribution", amount, date: new Date().toLocaleDateString() },
          ];
          const { data } = await supabase
            .from("members")
            .update({ balance: member.balance + amount, transactions: updatedTransactions })
            .eq("id", member.id)
            .select();
          await supabase
            .from("contributions")
            .insert([{ member_name: member.name, amount, date: new Date().toLocaleDateString() }]);
          setMembers(members.map((m, i) => (i === memberIndex ? data[0] : m)));
          setContributions([...contributions, { member_name: member.name, amount, date: new Date().toLocaleDateString() }]);
          setContributionInputs({ ...contributionInputs, [memberIndex]: "" });
          console.log("Added contribution for", member.name, ":", amount);
        } catch (e) {
          console.error("Error adding contribution:", e);
        }
      };

      const addEvent = async () => {
        if (!supabase || newEvent.totalCost <= 0 || newEvent.participants.length === 0) return;
        const costPerPerson = Math.floor(newEvent.totalCost / newEvent.participants.length);
        const eventDate = newEvent.date || new Date().toLocaleDateString();
        try {
          const updatedMembers = [...members];
          for (const memberIndex of newEvent.participants) {
            const member = updatedMembers[memberIndex];
            const updatedTransactions = [
              ...(member.transactions || []),
              { type: "meal", amount: costPerPerson, date: eventDate },
            ];
            const { data } = await supabase
              .from("members")
              .update({ balance: member.balance - costPerPerson, transactions: updatedTransactions })
              .eq("id", member.id)
              .select();
            updatedMembers[memberIndex] = data[0];
          }
          const { data: eventData } = await supabase
            .from("events")
            .insert([
              {
                total_cost: newEvent.totalCost,
                participants: newEvent.participants.map((i) => members[i].name),
                date: eventDate,
              },
            ])
            .select();
          setMembers(updatedMembers);
          setEvents([...events, eventData[0]]);
          setNewEvent({ totalCost: 0, participants: [], date: "" });
          console.log("Added event with total cost:", newEvent.totalCost);
        } catch (e) {
          console.error("Error adding event:", e);
        }
      };

      const toggleParticipant = (index) => {
        const participants = newEvent.participants.includes(index)
          ? newEvent.participants.filter((i) => i !== index)
          : [...newEvent.participants, index];
        setNewEvent({ ...newEvent, participants });
        console.log("Toggled participant:", members[index]?.name || "Unknown");
      };

      const handleContributionInput = (index, value) => {
        setContributionInputs({ ...contributionInputs, [index]: value });
      };

      const clearData = async () => {
        if (!supabase) return;
        if (window.confirm("Bạn có chắc muốn xóa toàn bộ dữ liệu? Hành động này không thể hoàn tác.")) {
          try {
            await supabase.from("members").delete().gte("id", 0);
            await supabase.from("inactive_members").delete().gte("id", 0);
            await supabase.from("events").delete().gte("id", 0);
            await supabase.from("contributions").delete().gte("id", 0);
            setMembers([]);
            setInactiveMembers([]);
            setEvents([]);
            setContributions([]);
            console.log("All data cleared from Supabase");
            window.location.reload();
          } catch (e) {
            console.error("Error clearing data:", e);
          }
        }
      };

      return (
        <div className="p-6 max-w-4xl mx-auto bg-gray-100 min-h-screen">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-center">Quản lý quỹ cơm</h1>
            <button
              onClick={clearData}
              className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600"
            >
              Xóa dữ liệu
            </button>
          </div>

          {/* Tabs */}
          <div className="flex mb-6 border-b border-gray-200">
            <button
              className={`px-4 py-2 font-semibold ${activeTab === "addMember" ? "border-b-2 border-blue-500 text-blue-500" : "text-gray-600"}`}
              onClick={() => setActiveTab("addMember")}
            >
              Thêm thành viên
            </button>
            <button
              className={`px-4 py-2 font-semibold ${activeTab === "contribute" ? "border-b-2 border-blue-500 text-blue-500" : "text-gray-600"}`}
              onClick={() => setActiveTab("contribute")}
            >
              Nộp quỹ
            </button>
            <button
              className={`px-4 py-2 font-semibold ${activeTab === "addEvent" ? "border-b-2 border-blue-500 text-blue-500" : "text-gray-600"}`}
              onClick={() => setActiveTab("addEvent")}
            >
              Thêm sự kiện
            </button>
          </div>

          {/* Tab Content */}
          {activeTab === "addMember" && (
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-semibold mb-2">Thêm thành viên</h2>
              <div className="flex items-center">
                <input
                  type="text"
                  value={newMemberName}
                  onChange={(e) => setNewMemberName(e.target.value)}
                  placeholder="Tên thành viên"
                  className="border border-gray-300 p-2 mr-2 rounded-lg flex-grow"
                />
                <button onClick={addMember} className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600">
                  Thêm
                </button>
              </div>
            </div>
          )}

          {activeTab === "contribute" && (
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-semibold mb-2">Nộp quỹ</h2>
              <div className="space-y-2">
                {members.map((member, index) => (
                  <div key={member.id} className="flex items-center">
                    <span className="w-32 text-right mr-2">{member.name}:</span>
                    <input
                      type="number"
                      value={contributionInputs[index] || ""}
                      onChange={(e) => handleContributionInput(index, e.target.value)}
                      placeholder="Số tiền (VND)"
                      className="border border-gray-300 p-2 mr-2 rounded-lg w-40"
                      min="0"
                      step="1"
                    />
                    <button
                      onClick={() => addContribution(index)}
                      className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600"
                    >
                      Nộp
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {activeTab === "addEvent" && (
            <div className="mb-6 bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-semibold mb-2">Thêm sự kiện (bữa ăn)</h2>
              <input
                type="number"
                value={newEvent.totalCost || ""}
                onChange={(e) => setNewEvent({ ...newEvent, totalCost: Math.floor(parseFloat(e.target.value) || 0) })}
                placeholder="Tổng chi phí (VND)"
                className="border border-gray-300 p-2 mb-2 w-full rounded-lg"
                min="0"
                step="1"
              />
              <input
                type="date"
                value={newEvent.date}
                onChange={(e) => setNewEvent({ ...newEvent, date: e.target.value })}
                className="border border-gray-300 p-2 mb-2 w-full rounded-lg"
              />
              <h3 className="font-semibold mb-2">Chọn thành viên tham gia:</h3>
              {members.map((member, index) => (
                <div key={member.id} className="flex items-center mb-2">
                  <input
                    type="checkbox"
                    checked={newEvent.participants.includes(index)}
                    onChange={() => toggleParticipant(index)}
                    className="mr-2"
                  />
                  <span>{member.name}</span>
                </div>
              ))}
              <button
                onClick={addEvent}
                className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 mt-2"
              >
                Thêm sự kiện
              </button>
            </div>
          )}

          {/* Danh sách thành viên */}
          <div className="mb-6 bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Danh sách thành viên</h2>
            <table className="w-full border-collapse">
              <thead>
                <tr className="bg-gray-200">
                  <th className="border p-2">Tên</th>
                  <th className="border p-2">Số dư (VND)</th>
                  <th className="border p-2">Hành động</th>
                </tr>
              </thead>
              <tbody>
                {members.map((member, index) => (
                  <tr key={member.id}>
                    <td className="border p-2">{member.name}</td>
                    <td className="border p-2">{formatVND(member.balance)}</td>
                    <td className="border p-2">
                      <button
                        onClick={() => removeMember(index)}
                        className="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600"
                      >
                        Loại bỏ
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Thành viên cũ */}
          <div className="mb-6 bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Thành viên cũ</h2>
            <table className="w-full border-collapse">
              <thead>
                <tr className="bg-gray-200">
                  <th className="border p-2">Tên</th>
                  <th className="border p-2">Số dư (VND)</th>
                  <th className="border p-2">Hành động</th>
                </tr>
              </thead>
              <tbody>
                {inactiveMembers.map((member, index) => (
                  <tr key={member.id}>
                    <td className="border p-2">{member.name}</td>
                    <td className="border p-2">{formatVND(member.balance)}</td>
                    <td className="border p-2">
                      <button
                        onClick={() => reactivateMember(index)}
                        className="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600"
                      >
                        Kích hoạt lại
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Lịch sử giao dịch */}
          <div className="mb-6 bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Lịch sử giao dịch</h2>
            {members.map((member, index) => (
              <div key={member.id} className="mb-4">
                <h3 className="font-semibold">{member.name}</h3>
                <ul>
                  {(member.transactions || []).map((txn, i) => (
                    <li key={i} className={txn.type === "contribution" ? "text-green-600" : "text-red-600"}>
                      {txn.date}: {txn.type === "contribution" ? "+" : "-"} {formatVND(txn.amount)} VND
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>

          {/* Lịch sử sự kiện nhóm */}
          <div className="bg-white p-4 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-2">Lịch sử sự kiện nhóm</h2>
            <ul>
              {events.map((event, index) => (
                <li key={event.id}>
                  {event.date}: Tổng chi phí {formatVND(event.total_cost)} VND, Thành viên: {event.participants.join(", ")}
                </li>
              ))}
            </ul>
          </div>
        </div>
      );
    };

    try {
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
      console.log("ReactDOM.createRoot called successfully");
    } catch (e) {
      console.error("Error rendering React app:", e);
    }
  </script>
</body>
</html>
